#!/bin/bash

# NOTE: To run this, you must give it executable permissions using the following command
# chmod +x compressExtract.sh

# Create delay between 10 and 30 seconds
randomDelay() {
    echo $((RANDOM % 21 + 10))
}

# Return a random zip file
randomZipFile() {
    zipFiles=(./Scripts/resources/compressTestDirectory/*.zip)
    if [ ${#zipFiles[@]} -eq 0 ]; then
        echo ""
    else
        echo ${zipFiles[RANDOM % ${#zipFiles[@]}]}
    fi
}

# Infinite loop
while true; do
    # Get a random delay and sleep for that duration
    delay=$(randomDelay)
    echo "Sleeping for $delay seconds"
    sleep $delay
    
    # Get a random .zip file from the directory
    currentZipFile=$(randomZipFile)
    if [ -z "$currentZipFile" ] || [ ! -f "$currentZipFile" ]; then
        echo "Error: No .zip files found in the directory."
        exit 1
    fi

    # Generate the timestamp
    timestamp=$(date +%s)
    unzipDir="./Scripts/resources/compressTestDirectory/$timestamp"

    # Unzip the file into the timestamp-named directory
    mkdir "$unzipDir"
    unzip "$currentZipFile" -d "$unzipDir"
    if [ $? -eq 0 ]; then
        echo "Unzipped $currentZipFile to $unzipDir"
    else
        echo "Failed to unzip $currentZipFile"
        rm -r "$unzipDir"
        continue
    fi
    
    # Re-zip the contents into a new .zip file with the timestamp name
    newZipFile="./Scripts/resources/compressTestDirectory/$timestamp.zip"
    (cd "$unzipDir" && zip -r "$newZipFile" .)
    if [ $? -eq 0 ]; then
        echo "Re-zipped contents to $newZipFile"
    else
        echo "Failed to re-zip contents"
        rm -r "$unzipDir"
        continue
    fi
    
    # Delete the original .zip file and the unzipped directory
    rm "$currentZipFile"
    if [ $? -eq 0 ]; then
        echo "Deleted original .zip file $currentZipFile"
    else
        echo "Failed to delete original .zip file $currentZipFile"
    fi

    rm -r "$unzipDir"
    if [ $? -eq 0 ]; then
        echo "Deleted unzipped directory $unzipDir"
    else
        echo "Failed to delete unzipped directory $unzipDir"
    fi
    
    echo "----------------------------------------"
done
